<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudLab Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0d1b2a 100%); min-height: 100vh; color: white; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 20px; margin-bottom: 20px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo h1 { font-size: 24px; background: linear-gradient(135deg, #7c3aed, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .logo p { font-size: 12px; color: #888; }
    .header-info { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.1); font-size: 14px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.on { background: #22c55e; box-shadow: 0 0 10px #22c55e; animation: pulse 2s infinite; }
    .dot.off { background: #ef4444; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* System Stats */
    .system-stats { display: flex; gap: 15px; flex-wrap: wrap; }
    .stat { background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 12px; text-align: center; min-width: 80px; }
    .stat-value { font-size: 18px; font-weight: bold; color: #7c3aed; }
    .stat-label { font-size: 10px; color: #888; text-transform: uppercase; }
    
    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    
    /* Cards */
    .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; transition: all 0.3s; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); border-color: rgba(124,58,237,0.3); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .card-title { display: flex; align-items: center; gap: 12px; }
    .card-title .icon { font-size: 32px; }
    .card-title h3 { font-size: 18px; font-weight: 600; }
    .card-title .subtitle { font-size: 12px; color: #888; }
    .card-body { margin-bottom: 16px; }
    
    /* URL Box */
    .url-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; color: #a78bfa; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .url-box.empty { color: #666; }
    .url-box a { color: #a78bfa; text-decoration: none; flex: 1; }
    .url-box a:hover { text-decoration: underline; }
    
    /* Buttons */
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; }
    .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    /* Sections */
    .section { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
    .section h2 { font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .section h2 .badge { background: #7c3aed; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
    
    /* Quick Actions */
    .quick-actions { display: flex; flex-wrap: wrap; gap: 12px; }
    
    /* Credentials */
    .credentials { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .cred-item { background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; }
    .cred-item label { font-size: 12px; color: #888; display: block; margin-bottom: 6px; }
    .cred-item .value { display: flex; align-items: center; gap: 8px; }
    .cred-item input { background: transparent; border: none; color: white; font-family: monospace; font-size: 14px; flex: 1; width: 100%; }
    .cred-item button { background: none; border: none; color: #888; cursor: pointer; font-size: 16px; padding: 4px; }
    .cred-item button:hover { color: white; }
    
    /* Terminal */
    .terminal { background: #0a0a0a; border-radius: 12px; padding: 16px; }
    .terminal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #333; }
    .terminal-header .dots { display: flex; gap: 6px; }
    .terminal-header .dots span { width: 12px; height: 12px; border-radius: 50%; }
    .terminal-header .dots span:nth-child(1) { background: #ef4444; }
    .terminal-header .dots span:nth-child(2) { background: #f59e0b; }
    .terminal-header .dots span:nth-child(3) { background: #22c55e; }
    .terminal-output { height: 250px; overflow-y: auto; font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 13px; line-height: 1.6; margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; }
    .terminal-output::-webkit-scrollbar { width: 8px; }
    .terminal-output::-webkit-scrollbar-track { background: transparent; }
    .terminal-output::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    .terminal-input { display: flex; gap: 8px; align-items: center; }
    .terminal-input .prompt { color: #22c55e; font-family: monospace; }
    .terminal-input input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; border-radius: 8px; color: white; font-family: monospace; font-size: 14px; }
    .terminal-input input:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,0.2); }
    
    /* Logs */
    .log-viewer { background: #0a0a0a; border-radius: 12px; padding: 16px; margin-top: 16px; }
    .log-viewer select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 8px; margin-right: 10px; }
    .log-content { height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.5; margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; white-space: pre-wrap; color: #888; }
    
    /* Kernel/Env Management */
    .management-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .management-item { background: rgba(0,0,0,0.2); padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
    .management-item .info h4 { font-size: 14px; margin-bottom: 4px; }
    .management-item .info p { font-size: 12px; color: #888; }
    
    /* Modals */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: linear-gradient(135deg, #1a1a3e, #0f0f23); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 32px; max-width: 450px; width: 90%; }
    .modal-content h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .modal-content label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; margin-top: 16px; }
    .modal-content input, .modal-content select { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; border-radius: 8px; color: white; font-size: 14px; }
    .modal-content input:focus, .modal-content select:focus { outline: none; border-color: #7c3aed; }
    .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
    .modal-actions .btn { flex: 1; justify-content: center; }
    
    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; z-index: 1000; animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; display: flex; align-items: center; gap: 10px; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .toast.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    
    /* Footer */
    footer { text-align: center; padding: 30px 20px; color: #666; font-size: 14px; }
    footer a { color: #7c3aed; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    
    /* Utility */
    .text-green { color: #22c55e; }
    .text-red { color: #ef4444; }
    .text-yellow { color: #fbbf24; }
    .text-blue { color: #3b82f6; }
    .text-purple { color: #a78bfa; }
    .text-dim { color: #666; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header-info { width: 100%; justify-content: space-between; }
      .system-stats { width: 100%; justify-content: space-around; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="logo">
        <div>
          <h1>‚òÅÔ∏è CloudLab Dashboard</h1>
          <p>Self-Hosted Web Editor by Sakib Dalal</p>
        </div>
      </div>
      <div class="header-info">
        <div class="system-stats" id="systemStats">
          <div class="stat"><div class="stat-value" id="cpuPercent">-</div><div class="stat-label">CPU</div></div>
          <div class="stat"><div class="stat-value" id="memPercent">-</div><div class="stat-label">RAM</div></div>
          <div class="stat"><div class="stat-value" id="diskPercent">-</div><div class="stat-label">Disk</div></div>
        </div>
        <div class="status-badge">
          <div class="dot" id="connDot"></div>
          <span id="connText">Connecting...</span>
        </div>
      </div>
    </header>

    <!-- Services Grid -->
    <div class="grid">
      <!-- Jupyter -->
      <div class="card" id="jupyterCard">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">üêç</span>
            <div>
              <h3>Jupyter</h3>
              <div class="subtitle" id="jupyterMode">Lab</div>
            </div>
          </div>
          <div class="dot" id="jupyterDot"></div>
        </div>
        <div class="card-body">
          <div class="url-box" id="jupyterUrlBox">
            <span>üîó</span>
            <a href="#" id="jupyterUrl" target="_blank">No tunnel URL</a>
          </div>
          <div class="url-box">
            <span>üè†</span>
            <a href="#" id="jupyterLocal" target="_blank">http://localhost:8888</a>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-warning" onclick="toggleService('jupyter')" id="jupyterBtn">Start</button>
          <button class="btn btn-secondary btn-sm" onclick="copyUrl('jupyter')" title="Copy URL">üìã</button>
          <button class="btn btn-secondary btn-sm" onclick="openUrl('jupyter')" title="Open">üîó</button>
          <button class="btn btn-secondary btn-sm" onclick="viewLogs('jupyter')" title="Logs">üìÑ</button>
        </div>
      </div>

      <!-- VS Code -->
      <div class="card" id="vscodeCard">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">üíª</span>
            <div>
              <h3>VS Code</h3>
              <div class="subtitle">code-server</div>
            </div>
          </div>
          <div class="dot" id="vscodeDot"></div>
        </div>
        <div class="card-body">
          <div class="url-box" id="vscodeUrlBox">
            <span>üîó</span>
            <a href="#" id="vscodeUrl" target="_blank">No tunnel URL</a>
          </div>
          <div class="url-box">
            <span>üè†</span>
            <a href="#" id="vscodeLocal" target="_blank">http://localhost:8080</a>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="toggleService('vscode')" id="vscodeBtn">Start</button>
          <button class="btn btn-secondary btn-sm" onclick="copyUrl('vscode')" title="Copy URL">üìã</button>
          <button class="btn btn-secondary btn-sm" onclick="openUrl('vscode')" title="Open">üîó</button>
          <button class="btn btn-secondary btn-sm" onclick="viewLogs('vscode')" title="Logs">üìÑ</button>
        </div>
      </div>

      <!-- SSH Terminal -->
      <div class="card" id="sshCard">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">üîí</span>
            <div>
              <h3>SSH Terminal</h3>
              <div class="subtitle">ttyd</div>
            </div>
          </div>
          <div class="dot" id="sshDot"></div>
        </div>
        <div class="card-body">
          <div class="url-box" id="sshUrlBox">
            <span>üîó</span>
            <a href="#" id="sshUrl" target="_blank">No tunnel URL</a>
          </div>
          <div class="url-box">
            <span>üè†</span>
            <a href="#" id="sshLocal" target="_blank">http://localhost:7681</a>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="toggleService('ssh')" id="sshBtn">Start</button>
          <button class="btn btn-secondary btn-sm" onclick="copyUrl('ssh')" title="Copy URL">üìã</button>
          <button class="btn btn-secondary btn-sm" onclick="openUrl('ssh')" title="Open">üîó</button>
          <button class="btn btn-secondary btn-sm" onclick="viewLogs('ssh')" title="Logs">üìÑ</button>
        </div>
      </div>

      <!-- Dashboard -->
      <div class="card" id="dashboardCard">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">üìä</span>
            <div>
              <h3>Dashboard</h3>
              <div class="subtitle">This page</div>
            </div>
          </div>
          <div class="dot on" id="dashboardDot"></div>
        </div>
        <div class="card-body">
          <div class="url-box" id="dashboardUrlBox">
            <span>üîó</span>
            <a href="#" id="dashboardUrl" target="_blank">No tunnel URL</a>
          </div>
          <div class="url-box">
            <span>üè†</span>
            <a href="#" id="dashboardLocal" target="_blank">http://localhost:3000</a>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" disabled>Running</button>
          <button class="btn btn-secondary btn-sm" onclick="copyUrl('dashboard')" title="Copy URL">üìã</button>
          <button class="btn btn-secondary btn-sm" onclick="openUrl('dashboard')" title="Open">üîó</button>
          <button class="btn btn-secondary btn-sm" onclick="viewLogs('dashboard')" title="Logs">üìÑ</button>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="section">
      <h2>‚ö° Quick Actions</h2>
      <div class="quick-actions">
        <button class="btn btn-success" onclick="runCmd('start', 'all')">‚ñ∂Ô∏è Start All</button>
        <button class="btn btn-danger" onclick="runCmd('stop', 'all')">‚èπÔ∏è Stop All</button>
        <button class="btn btn-warning" onclick="runCmd('restart', 'all')">üîÑ Restart All</button>
        <button class="btn btn-primary" onclick="runCmd('tunnel', 'start')">üåê Start Tunnels</button>
        <button class="btn btn-primary" onclick="runCmd('tunnel', 'restart')">üîó New URLs</button>
        <button class="btn btn-secondary" onclick="runCmd('tunnel', 'stop')">üö´ Stop Tunnels</button>
        <button class="btn btn-secondary" onclick="runCmd('email', 'send')">üìß Email URLs</button>
        <button class="btn btn-secondary" onclick="runCmd('status')">üìä Refresh Status</button>
      </div>
    </div>

    <!-- Credentials -->
    <div class="section">
      <h2>üîê Credentials</h2>
      <div class="credentials">
        <div class="cred-item">
          <label>Jupyter Password</label>
          <div class="value">
            <input type="password" id="jupyterPass" readonly>
            <button onclick="togglePass('jupyterPass')" title="Show/Hide">üëÅÔ∏è</button>
            <button onclick="copyField('jupyterPass')" title="Copy">üìã</button>
          </div>
        </div>
        <div class="cred-item">
          <label>VS Code Password</label>
          <div class="value">
            <input type="password" id="vscodePass" readonly>
            <button onclick="togglePass('vscodePass')" title="Show/Hide">üëÅÔ∏è</button>
            <button onclick="copyField('vscodePass')" title="Copy">üìã</button>
          </div>
        </div>
        <div class="cred-item">
          <label>SSH Username</label>
          <div class="value">
            <input type="text" id="sshUser" readonly>
            <button onclick="copyField('sshUser')" title="Copy">üìã</button>
          </div>
        </div>
        <div class="cred-item">
          <label>SSH Password</label>
          <div class="value">
            <input type="password" id="sshPass" readonly>
            <button onclick="togglePass('sshPass')" title="Show/Hide">üëÅÔ∏è</button>
            <button onclick="copyField('sshPass')" title="Copy">üìã</button>
          </div>
        </div>
        <div class="cred-item">
          <label>Working Directory</label>
          <div class="value">
            <input type="text" id="workDir" readonly>
            <button onclick="copyField('workDir')" title="Copy">üìã</button>
          </div>
        </div>
        <div class="cred-item">
          <label>Python Version</label>
          <div class="value">
            <input type="text" id="pythonVer" readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- Kernel Management -->
    <div class="section">
      <h2>üìì Kernel Management <span class="badge">Jupyter</span></h2>
      <div class="quick-actions mb-4">
        <button class="btn btn-secondary" onclick="runCmd('kernel', 'list')">üìã List Kernels</button>
        <button class="btn btn-success" onclick="showModal('kernelModal')">‚ûï Add Kernel</button>
      </div>
      <div id="kernelList" class="management-grid mt-4"></div>
    </div>

    <!-- Environment Management -->
    <div class="section">
      <h2>üêç Environment Management <span class="badge">UV</span></h2>
      <div class="quick-actions">
        <button class="btn btn-secondary" onclick="runCmd('env', 'list')">üìã List Environments</button>
        <button class="btn btn-success" onclick="showModal('envModal')">‚ûï Create Environment</button>
        <button class="btn btn-primary" onclick="showModal('installModal')">üì¶ Install Package</button>
      </div>
      <div id="envList" class="management-grid mt-4"></div>
    </div>

    <!-- Terminal -->
    <div class="section">
      <h2>üíª Terminal</h2>
      <div class="terminal">
        <div class="terminal-header">
          <div class="dots"><span></span><span></span><span></span></div>
          <div>
            <button class="btn btn-secondary btn-sm" onclick="clearTerminal()">Clear</button>
          </div>
        </div>
        <div class="terminal-output" id="terminalOutput">
          <div class="text-green">‚òÅÔ∏è CloudLab Terminal Ready</div>
          <div class="text-dim">Type a cloudlab command or use quick actions above</div>
          <div class="text-dim">Example: status, start jupyter, tunnel start</div>
        </div>
        <div class="terminal-input">
          <span class="prompt">cloudlab $</span>
          <input type="text" id="terminalInput" placeholder="Enter command..." onkeypress="if(event.key==='Enter')executeCmd()">
          <button class="btn btn-success" onclick="executeCmd()">Run</button>
        </div>
      </div>
      
      <!-- Log Viewer -->
      <div class="log-viewer">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <label style="color:#888;">View Logs:</label>
          <select id="logService" onchange="loadLogs()">
            <option value="jupyter">Jupyter</option>
            <option value="vscode">VS Code</option>
            <option value="ssh">SSH</option>
            <option value="dashboard">Dashboard</option>
            <option value="tunnel_jupyter">Tunnel Jupyter</option>
            <option value="tunnel_vscode">Tunnel VS Code</option>
            <option value="tunnel_ssh">Tunnel SSH</option>
            <option value="tunnel_dashboard">Tunnel Dashboard</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="loadLogs()">üîÑ Refresh</button>
        </div>
        <pre class="log-content" id="logContent">Select a service and click refresh to view logs</pre>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p>CloudLab v1.2.0 | Author: <a href="https://github.com/Sakib-Dalal" target="_blank">Sakib Dalal</a> | <a href="https://github.com/Sakib-Dalal" target="_blank">GitHub</a></p>
    </footer>
  </div>

  <!-- Add Kernel Modal -->
  <div class="modal" id="kernelModal">
    <div class="modal-content">
      <h3>üìì Add New Kernel</h3>
      <label>Kernel Name</label>
      <input type="text" id="kernelName" placeholder="e.g., datascience, ml-project">
      <label>Python Version</label>
      <input type="text" id="kernelPython" placeholder="e.g., 3.10, 3.11" value="3.11">
      <div class="modal-actions">
        <button class="btn btn-success" onclick="addKernel()">‚ú® Create Kernel</button>
        <button class="btn btn-secondary" onclick="hideModal('kernelModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Create Environment Modal -->
  <div class="modal" id="envModal">
    <div class="modal-content">
      <h3>üêç Create Environment</h3>
      <label>Environment Name</label>
      <input type="text" id="envName" placeholder="e.g., ml-project, web-app">
      <label>Python Version</label>
      <input type="text" id="envPython" placeholder="e.g., 3.10, 3.11" value="3.11">
      <div class="modal-actions">
        <button class="btn btn-success" onclick="createEnv()">‚ú® Create</button>
        <button class="btn btn-secondary" onclick="hideModal('envModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Install Package Modal -->
  <div class="modal" id="installModal">
    <div class="modal-content">
      <h3>üì¶ Install Package</h3>
      <label>Package Name(s)</label>
      <input type="text" id="packageName" placeholder="e.g., numpy pandas scikit-learn">
      <p class="text-dim mt-2" style="font-size:12px;">Separate multiple packages with spaces</p>
      <div class="modal-actions">
        <button class="btn btn-success" onclick="installPackage()">üì• Install</button>
        <button class="btn btn-secondary" onclick="hideModal('installModal')">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let status = {};
    let config = {};
    let tunnelUrls = {};

    // Fetch status from API
    async function fetchStatus() {
      try {
        const res = await fetch('/api/status');
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        status = data;
        config = data.config || {};
        tunnelUrls = config.tunnel_urls || {};
        updateUI(data);
        setConnected(true);
      } catch (e) {
        console.error('Status fetch error:', e);
        setConnected(false);
      }
    }

    // Update UI with status data
    function updateUI(data) {
      // Services
      updateServiceCard('jupyter', data.jupyter, tunnelUrls.jupyter, config.jupyter_port || 8888);
      updateServiceCard('vscode', data.vscode, tunnelUrls.vscode, config.vscode_port || 8080);
      updateServiceCard('ssh', data.ssh, tunnelUrls.ssh, config.ssh_port || 7681);
      updateServiceCard('dashboard', true, tunnelUrls.dashboard, config.dashboard_port || 3000);

      // Jupyter mode
      const mode = config.jupyter_mode || 'lab';
      document.getElementById('jupyterMode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);

      // Credentials
      document.getElementById('jupyterPass').value = config.jupyter_password || '';
      document.getElementById('vscodePass').value = config.vscode_password || '';
      document.getElementById('sshUser').value = config.ssh_user || '';
      document.getElementById('sshPass').value = config.ssh_password || 'System auth';
      document.getElementById('workDir').value = config.working_directory || '~';
      document.getElementById('pythonVer').value = config.python_version || '3.11';

      // System stats
      if (data.system) {
        document.getElementById('cpuPercent').textContent = (data.system.cpu_percent || 0) + '%';
        document.getElementById('memPercent').textContent = (data.system.memory_percent || 0) + '%';
        document.getElementById('diskPercent').textContent = (data.system.disk_percent || 0) + '%';
      }

      // Environments
      if (data.environments) {
        renderEnvList(data.environments);
      }
    }

    function updateServiceCard(name, running, tunnelUrl, port) {
      const dot = document.getElementById(name + 'Dot');
      const btn = document.getElementById(name + 'Btn');
      const urlEl = document.getElementById(name + 'Url');
      const urlBox = document.getElementById(name + 'UrlBox');
      const localEl = document.getElementById(name + 'Local');

      // Status dot
      if (dot) {
        dot.className = 'dot ' + (running ? 'on' : 'off');
      }

      // Button text
      if (btn && name !== 'dashboard') {
        btn.textContent = running ? 'Stop' : 'Start';
        btn.className = running ? 'btn btn-danger' : 'btn btn-success';
      }

      // Tunnel URL
      if (urlEl && urlBox) {
        if (tunnelUrl) {
          urlEl.textContent = tunnelUrl;
          urlEl.href = tunnelUrl;
          urlBox.classList.remove('empty');
        } else {
          urlEl.textContent = 'No tunnel URL';
          urlEl.href = '#';
          urlBox.classList.add('empty');
        }
      }

      // Local URL
      if (localEl) {
        const localUrl = `http://localhost:${port}`;
        localEl.textContent = localUrl;
        localEl.href = localUrl;
      }
    }

    function setConnected(connected) {
      const dot = document.getElementById('connDot');
      const text = document.getElementById('connText');
      dot.className = 'dot ' + (connected ? 'on' : 'off');
      text.textContent = connected ? 'Connected' : 'Offline';
    }

    // Run cloudlab command
    async function runCmd(...args) {
      const cmdStr = args.join(' ');
      appendTerminal(`$ cloudlab ${cmdStr}`, 'text-green');
      
      try {
        const res = await fetch('/api/command/' + args.join('/'));
        const data = await res.json();
        
        if (data.stdout) {
          data.stdout.split('\n').forEach(line => {
            if (line.trim()) appendTerminal(line, getLineColor(line));
          });
        }
        if (data.stderr) {
          data.stderr.split('\n').forEach(line => {
            if (line.trim()) appendTerminal(line, 'text-yellow');
          });
        }
        
        showToast(data.success ? 'Command executed' : 'Command failed', data.success ? 'success' : 'error');
        
        // Refresh status after command
        setTimeout(fetchStatus, 2000);
      } catch (e) {
        appendTerminal('Error: ' + e.message, 'text-red');
        showToast('Command failed', 'error');
      }
    }

    function getLineColor(line) {
      if (line.includes('‚úì') || line.includes('[Running]') || line.includes('success')) return 'text-green';
      if (line.includes('‚úó') || line.includes('error') || line.includes('Error')) return 'text-red';
      if (line.includes('‚ö†') || line.includes('warning')) return 'text-yellow';
      if (line.includes('http') || line.includes('https')) return 'text-purple';
      return 'text-dim';
    }

    function toggleService(name) {
      const running = status[name];
      runCmd(running ? 'stop' : 'start', name);
    }

    function copyUrl(name) {
      const url = tunnelUrls[name];
      if (url) {
        navigator.clipboard.writeText(url);
        showToast('Tunnel URL copied', 'success');
      } else {
        // Copy local URL
        const ports = { 
          jupyter: config.jupyter_port || 8888, 
          vscode: config.vscode_port || 8080, 
          ssh: config.ssh_port || 7681, 
          dashboard: config.dashboard_port || 3000 
        };
        navigator.clipboard.writeText(`http://localhost:${ports[name]}`);
        showToast('Local URL copied', 'info');
      }
    }

    function openUrl(name) {
      const tunnelUrl = tunnelUrls[name];
      if (tunnelUrl) {
        window.open(tunnelUrl, '_blank');
      } else {
        const ports = { 
          jupyter: config.jupyter_port || 8888, 
          vscode: config.vscode_port || 8080, 
          ssh: config.ssh_port || 7681, 
          dashboard: config.dashboard_port || 3000 
        };
        window.open(`http://localhost:${ports[name]}`, '_blank');
      }
    }

    function viewLogs(service) {
      document.getElementById('logService').value = service;
      loadLogs();
    }

    async function loadLogs() {
      const service = document.getElementById('logService').value;
      const logContent = document.getElementById('logContent');
      logContent.textContent = 'Loading logs...';
      
      try {
        const res = await fetch(`/api/logs?service=${service}&lines=100`);
        const data = await res.json();
        logContent.textContent = data.log || 'No logs available';
        logContent.scrollTop = logContent.scrollHeight;
      } catch (e) {
        logContent.textContent = 'Error loading logs: ' + e.message;
      }
    }

    // Terminal
    function appendTerminal(text, className) {
      const output = document.getElementById('terminalOutput');
      const div = document.createElement('div');
      div.className = className || '';
      div.textContent = text;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }

    function clearTerminal() {
      document.getElementById('terminalOutput').innerHTML = '<div class="text-green">Terminal cleared</div>';
    }

    function executeCmd() {
      const input = document.getElementById('terminalInput');
      const cmd = input.value.trim();
      if (!cmd) return;
      input.value = '';
      runCmd(...cmd.split(/\s+/));
    }

    // Credentials
    function togglePass(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function copyField(id) {
      const input = document.getElementById(id);
      navigator.clipboard.writeText(input.value);
      showToast('Copied to clipboard', 'success');
    }

    // Environments
    function renderEnvList(envs) {
      const container = document.getElementById('envList');
      if (!envs || envs.length === 0) {
        container.innerHTML = '<p class="text-dim">No environments found</p>';
        return;
      }
      container.innerHTML = envs.map(env => `
        <div class="management-item">
          <div class="info">
            <h4>${env.default ? '‚≠ê ' : ''}${env.name}</h4>
            <p>${env.path}</p>
          </div>
          ${!env.default ? `<button class="btn btn-danger btn-sm" onclick="removeEnv('${env.name}')">üóëÔ∏è</button>` : ''}
        </div>
      `).join('');
    }

    // Modals
    function showModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function hideModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function addKernel() {
      const name = document.getElementById('kernelName').value.trim();
      const python = document.getElementById('kernelPython').value.trim() || '3.11';
      if (!name) { showToast('Enter kernel name', 'error'); return; }
      hideModal('kernelModal');
      runCmd('kernel', 'add', name, python);
      document.getElementById('kernelName').value = '';
    }

    function createEnv() {
      const name = document.getElementById('envName').value.trim();
      const python = document.getElementById('envPython').value.trim() || '3.11';
      if (!name) { showToast('Enter environment name', 'error'); return; }
      hideModal('envModal');
      runCmd('env', 'create', name, python);
      document.getElementById('envName').value = '';
    }

    function removeEnv(name) {
      if (confirm(`Remove environment "${name}"?`)) {
        runCmd('env', 'remove', name);
      }
    }

    function installPackage() {
      const pkg = document.getElementById('packageName').value.trim();
      if (!pkg) { showToast('Enter package name', 'error'); return; }
      hideModal('installModal');
      runCmd('env', 'install', pkg);
      document.getElementById('packageName').value = '';
    }

    // Toast notifications
    function showToast(msg, type) {
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span> ${msg}`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Close modals on backdrop click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) modal.classList.remove('active');
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
      }
    });

    // Initialize
    fetchStatus();
    setInterval(fetchStatus, 5000);
  </script>
</body>
</html>
